### 存储引擎

- MyISAM

  读写锁调度是写优先，不适合频繁插入和修改的情况

- InnoDB

### 锁

- 锁的分类

  从锁的粒度上来看，锁可以分为

  - 表锁

    锁定一张表

  - 行锁

    锁定一行

  - 页锁

    锁定一页（针对B+树这种以页为存储单位的索引结构）

### 事务

> 为什么需要事务？
>
> 什么是事务？
>
> 如何实现事务？

- 事务提供的安全保证：ACID

  - Automicity（可终止性）：原子性，发生错误时终止事务，丢弃此前所有的写入
  - Consistency：一致性，保证数据库从一个正确状态进入另一个正确状态，也就是说事务前后数据库的约束条件等应该始终满足。一致性并不保证事务执行的正确性（DB只是用于存储数据，并不知道用户定义的“正确状态”），**应该由程序员来保证。**
  - Isolation：隔离性，多个并发执行的事务之间应该相互隔离，并发事务执行的结果应该与串行执行结果一致（可串行化）
  - Durability：持久性，一旦事务完成，写入的任何数据不会消失（被写入磁盘等非易失性存储中）

- 事务隔离级别：

  - 读未提交（Read uncommitted）

  - 读已提交（Read committed，不可重复读）

  - 可重复读：

    可用快照隔离实现：

    > Why？--实现读和写不相互阻塞，提升并发性
    >
    > What？--用户读取的是某个时刻的快照，事务可以看到事务开始时在数据库中提交的所有数据。即使这些数据随后被另一个事务更改，每个事务也只能看到该特定时间点的旧数据。
    >
    > How？
    >
    > - InnoDB中的MVCC：https://segmentfault.com/a/1190000037557620	

    为了实现快照隔离，需要维护在多个时间点的多个对象版本

    ![image-20211101203746591](https://i.loli.net/2021/11/01/gGFH5dWqUKsYxQS.png)

    一致性快照的可见性规则：

    - 在一个事务开始时，数据库列出当时所有未提交和终止的事务清单，即使之后提交了，其写入也会被忽略
    - 被终止的事务所执行的任何写入都会被忽略
    - 较晚事务所执行的任何写入都会被忽略

    > **注：**如果某个事务删除了一行，那么该行实际上并未从数据库中删除，而是通过将 `deleted_by` 字段设置为请求删除的事务的ID来标记为删除。在稍后的时间，当确定没有事务可以再访问已删除的数据时，数据库中的垃圾收集过程会将所有带有删除标记的行移除，并释放其空间。

